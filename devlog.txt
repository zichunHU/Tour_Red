### **开发日志 (Development Log)**

**项目:** "红色印记：上海红色文旅双语导览平台"
**日期:** 2025年10月16日
**阶段:** 项目初始化与基本框架搭建

*   **[分析] 需求与架构分析:**
    *   阅读并理解了 `struct.txt` (技术架构)，明确了采用 `Vue.js` (前端) + `Python` (后端) + `JSON文件` (数据存储) 的技术路线。
    *   阅读并理解了 `task.txt` (项目需求)，明确了项目的功能目标，如智能推荐、关键词串联、双语支持等。

*   **[执行] 后端框架搭建:**
    *   创建了 `backend/data` 目录结构。
    *   创建了 `backend/requirements.txt` 并添加了 `Flask` 和 `Flask-Cors` 依赖。
    *   创建了 `backend/main.py`，并初始化了一个基础的、支持跨域 (CORS) 的 Flask Web 服务。
    *   在 `backend/data/` 目录下创建了 `attractions.json`, `routes.json`, `users.json` 三个空的JSON文件作为初始数据源。

*   **[执行] 前端框架搭建:**
    *   创建了 `frontend/src` 目录结构。
    *   创建了 `frontend/package.json`，配置了 `Vite` 作为构建工具，并添加了 `vue` 依赖。
    *   创建了前端入口页面 `frontend/index.html` 和 Vue 初始化脚本 `frontend/src/main.js`。
    *   创建了 Vue 的根组件 `frontend/src/App.vue`。

*   **[修复] 前端启动问题:**
    *   **问题:** `npm run dev` 启动时，Vite 报错 `Failed to parse source for import analysis`，无法处理 `.vue` 文件。
    *   **原因:** 忘记创建 Vite 配置文件来启用 Vue 插件。
    *   **解决:** 创建并配置了 `frontend/vite.config.js` 文件，在其中引入并使用了 `@vitejs/plugin-vue` 插件，问题解决。

*   **[执行] 实现景点列表功能 (端到端):**
    *   **数据:** 向 `backend/data/attractions.json` 添加了示例数据。
    *   **后端:** 在 `backend/main.py` 中创建了 `/api/attractions` API 接口，用于读取并返回景点数据。
    *   **前端:** 修改了 `frontend/src/App.vue`，实现了从后端获取数据、处理加载/错误状态，并使用 `v-for` 将景点列表渲染到页面上。
    *   **结果:** 成功打通前后端，实现了第一个核心功能的垂直切片。

*   **[执行] 集成 Vue Router 并重构前端结构:**
    *   **安装:** 在 `frontend` 目录中安装了 `vue-router`。
    *   **结构:** 创建了 `src/views` 和 `src/router` 目录。
    *   **页面:** 创建了6个核心页面的组件文件（`HomePage`, `AttractionListPage` 等）。
    *   **迁移:** 将景点列表的获取和显示逻辑从 `App.vue` 迁移到了 `views/AttractionListPage.vue`。
    *   **配置:** 创建了 `router/index.js` 配置文件，定义了所有页面的路由。
    *   **集成:** 修改了 `main.js` 以启用 `vue-router`。
    *   **布局:** 重构了 `App.vue`，使其成为包含全局导航栏和 `<router-view>` 的主布局文件。
    *   **结果:** 应用现在是单页应用（SPA），具备了多页面导航能力。

*   **[执行] 前端界面美化 (Apple Design):**
    *   **全局样式 (`App.vue`):**
        *   引入了类似 Apple Design 的设计系统变量（颜色、字体、圆角、阴影）。
        *   导航栏采用白色背景、底部边框和柔和阴影，提升了层次感。
        *   优化了导航链接的字体、颜色和激活状态，使其更清晰、更精致。
        *   更新了全局背景色和字体，提升了整体的视觉清晰度。
    *   **景点列表页 (`AttractionListPage.vue`):**
        *   重新设计了景点卡片，应用了更大的圆角 (`16px`) 和更柔和、更具层次感的阴影。
        *   增加了卡片的鼠标悬浮（hover）动效，提升了交互感。
        *   优化了卡片内部的文字排版和间距，使内容更易读。
        *   为“地区”标签添加了独立的样式，使其成为一个标签元素。

*   **[执行] 完成景点详情功能闭环:**
    *   **前端 (列表页):** 修改了 `AttractionListPage.vue`，使用 `<router-link>` 将每个景点卡片转换为指向详情页的动态链接。
    *   **后端 (API):** 在 `main.py` 中新增了 `/api/attractions/<int:attraction_id>` 接口，用于根据ID查找并返回单个景点的数据。
    *   **前端 (详情页):** 完整实现了 `AttractionDetailPage.vue`。该页面能从URL中获取ID，调用后端接口获取数据，并以符合设计风格的布局展示景点名称、标签、中英文介绍等详细信息。添加了“返回列表”按钮。
    *   **结果:** 成功完成了“浏览列表 -> 点击 -> 查看详情”的核心用户流程。

*   **[执行] 实现景点列表的搜索与筛选功能:**
    *   **前端 (UI):** 在 `AttractionListPage.vue` 中添加了用于关键词搜索的输入框，以及按“区域”和“主题”筛选的下拉菜单。
    *   **前端 (逻辑):** 重构了数据获取逻辑，现在可以根据用户输入构建查询URL（如 `?keyword=...&area=...`）并向后端请求数据。
    *   **后端 (API):** 升级了 `/api/attractions` 接口，使其能够解析URL查询参数，并根据参数（`keyword`, `area`, `theme`）对景点数据进行动态筛选，最后返回筛选后的结果。
    *   **结果:** “景点列表页”的核心交互功能已完成，用户可以方便地查找特定景点。

*   **[执行] 完成“路线”功能模块开发:**
    *   **数据:** 向 `routes.json` 文件添加了包含景点ID关联的示例路线数据。
    *   **后端 (API):** 在 `main.py` 中新增了 `/api/routes` 和 `/api/routes/<id>` 两个接口。详情接口会返回包含完整景点信息的“富集”数据。
    *   **前端 (列表页):** 实现了 `RouteListPage.vue`，用于获取并展示所有预设路线的列表。
    *   **前端 (详情页):** 实现了 `RouteDetailPage.vue`，用于展示单条路线的详细信息，并列出其中包含的所有景点（可点击跳转）。
    *   **结果:** 成功完成了“浏览路线 -> 点击 -> 查看路线详情（含景点列表）”的核心用户流程，应用内容得到扩充。

---

**日期:** 2025年10月16日 (续)
**阶段:** 核心功能增强与架构重构

*   **[重构] 数据存储结构升级:**
    *   **动机:** 为了支持更丰富的景点内容（如多张图片），将原有的单一 `attractions.json` 文件废弃。
    *   **方案:** 每个景点现在拥有一个独立的文件夹（以英文缩写命名），其中包含 `data.json` 文件和相关的图片资源。
    *   **执行:** 创建了 `backend/data/attractions` 目录，并为现有景点数据创建了对应的子目录和文件，旧的 `attractions.json` 已被删除。

*   **[执行] 实现图文混排功能:**
    *   **后端:** 重写了后端API，使其能够从新的目录结构中读取数据，并配置了静态文件服务以提供图片。
    *   **前端 (列表页):** `AttractionListPage.vue` 已更新，现在每个景点卡片都会显示一张封面图片。
    *   **前端 (详情页):** `AttractionDetailPage.vue` 已更新，添加了顶部的“英雄图”(Hero Image)。
    *   **前端 (富文本):**
        *   为前端项目安装了 `marked` 库，用于解析Markdown文本。
        *   将景点的 `description` 字段升级为Markdown格式，允许在文本中嵌入图片。
        *   `AttractionDetailPage.vue` 现在使用 `v-html` 指令渲染由 `marked` 解析后的HTML，实现了图文混排的介绍详情。

*   **[修复] 后端 500 错误:**
    *   **问题:** 在实现图文混排后，访问API时出现 "500 Internal Server Error"，错误信息为 "invalid group reference"。
    *   **原因:** 在 `main.py` 中，用于处理Markdown图片路径的正则表达式 `re.sub` 调用存在语法缺陷，导致服务器在处理数据时崩溃。
    *   **解决:** 重写了 `re.sub` 的替换逻辑，使用更安全的回调函数模式代替了有问题的f-string格式化，彻底解决了该bug。

*   **[重构] 后端模块化:**
    *   **动机:** `main.py` 文件变得过于庞大和复杂，不利于维护。
    *   **方案:** 采用Flask蓝图 (Blueprints) 和应用工厂 (Application Factory) 模式进行重构。
    *   **执行:**
        *   创建了 `backend/app` 包，其中包含 `data_loader.py` (数据逻辑), `attractions_bp.py` (景点API), 和 `routes_bp.py` (路线API)。
        *   在 `app/__init__.py` 中创建了 `create_app` 工厂函数，用于组装应用。
        *   使用新的 `run.py` 作为启动脚本，替代了旧的 `main.py`。
    *   **结果:** 后端代码现在结构清晰，职责分离，更易于维护和扩展。

---

**日期:** 2025年10月17日
**阶段:** 修复与优化

*   **[修复] 解决前端 "Failed to fetch" 加载失败问题:**
    *   **问题:** 前端应用在访问后端API时出现网络请求失败，导致无法加载数据。
    *   **原因:** 前端代码中硬编码了后端API地址 (`http://127.0.0.1:5000`)，引发了浏览器的跨域资源共享 (CORS) 限制。
    *   **解决:**
        1.  **配置代理:** 修改了 `frontend/vite.config.js`，添加了开发服务器代理，将所有 `/api` 前缀的请求转发到后端服务。
        2.  **移除硬编码:** 全面检查并修改了所有发起API请求的Vue组件，将写死的绝对URL替换为相对路径 (`/api`)，从而使请求通过Vite代理，规避了跨域问题。
    *   **结果:** 彻底解决了应用范围内的跨域请求问题，前后端数据交互恢复正常。

*   **[改进] 管理系统富文本编辑器集成:**
    *   **目标:** 将景点管理中的文本编辑框升级为现代富文本编辑器，支持图片上传。
    *   **后端:**
        1.  `backend/requirements.txt` 添加 `bleach` 库用于HTML净化。
        2.  `backend/app/attractions_bp.py` 新增 `POST /api/attractions/<id>/images` 接口，处理图片上传，保存到景点目录并返回URL。
        3.  `backend/app/attractions_bp.py` 修改 `PUT /api/attractions/<id>` 接口，在保存前对 `description` 和 `description_en` 字段进行HTML净化。
    *   **前端:**
        1.  `frontend/package.json` 添加 `@tiptap/vue-3`, `@tiptap/starter-kit`, `@tiptap/extension-image` 依赖。
        2.  创建 `frontend/src/components/RichTextEditor.vue` 组件，封装 Tiptap 编辑器，包含工具栏和图片上传逻辑。
        3.  `frontend/src/views/AttractionForm.vue` 替换 `<textarea>` 为 `RichTextEditor` 组件，并调整数据绑定。
        4.  `frontend/src/views/AttractionDetailPage.vue` 移除 `marked` 库，直接使用 `v-html` 渲染HTML内容。
    *   **[修复] 富文本编辑器图片上传问题:**
        1.  **问题:** 点击“Add Image”按钮时，意外触发父表单提交，导致图片上传失败。
        2.  **原因:** `RichTextEditor.vue` 中的按钮默认 `type="submit"`。
        3.  **解决:** 将 `RichTextEditor.vue` 中所有工具栏按钮的 `type` 属性明确设置为 `"button"`。
        4.  **问题:** 新建景点时，`attractionId` 为 `0`，导致图片上传接口调用失败。
        5.  **解决:** 在 `RichTextEditor.vue` 中，当 `attractionId` 为 `0` 时，禁用“Add Image”按钮，提示用户先保存景点。
    *   **结果:** 管理系统现在拥有一个功能完善的富文本编辑器，支持图片上传，并解决了相关交互问题。

*   **[改进] 管理系统景点主图片编辑功能:**
    *   **目标:** 允许用户在景点编辑页面直接上传和修改景点的主图片。
    *   **前端:**
        1.  创建 `frontend/src/components/SingleImageUpload.vue` 组件，用于处理单个图片的上传和预览。
        2.  修改 `frontend/src/views/AttractionForm.vue`，引入 `SingleImageUpload` 组件，并用它替换原有的 `image_url` 输入框。
        3.  调整 `AttractionForm.vue` 中 `attraction` 对象的初始化，确保 `image_url` 字段能正确绑定和更新。
    *   **后端:** 复用已有的 `POST /api/attractions/<id>/images` 接口进行图片上传。
    *   **结果:** 管理员现在可以方便地为每个景点上传和更新主图片。

*   **[改进] 管理系统美化与密码保护:**
    *   **目标:** 美化后台管理面板 (`/admin`) 并为其添加密码保护。
    *   **前端:**
        1.  **美化 `AdminDashboard.vue`:** 调整布局和样式，使其更具现代感和专业性。
        2.  **登录页面:** 创建 `frontend/src/views/LoginPage.vue`，提供用户名和密码输入。
        3.  **路由守卫:** 修改 `frontend/src/router/index.js`，添加 `/login` 路由，并实现全局导航守卫，保护所有 `/admin` 路径，未登录用户将重定向到登录页。
        4.  **登出功能:** 修改 `frontend/src/App.vue`，添加一个在登录状态下显示的“登出”按钮，并实现清除登录状态的逻辑。
    *   **后端:**
        1.  **认证蓝图:** 创建 `backend/app/auth_bp.py`，实现 `POST /api/login` 接口，用于验证用户名和密码（硬编码为 `admin`/`password`）。
        2.  **注册蓝图:** 在 `backend/app/__init__.py` 中注册 `auth_bp` 蓝图。
    *   **结果:** 管理后台现在拥有更美观的界面，并通过用户名 `admin` 和密码 `password` 实现了基本的访问控制。